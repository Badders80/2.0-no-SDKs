"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const b=require("cookie-storage"),A=require("jwt-decode"),d=require("oidc-client-ts"),_=require("viem"),g=require("viem/chains"),r=require("zod"),x=17672,w="https://porcini.devnet.rootnet.app/",k="wss://porcini.devnet.rootnet.app/ws",P=_.defineChain({id:x,name:"Porcini Devnet (Testnet)",network:"sprout-1",nativeCurrency:{name:"XRP",symbol:"XRP",decimals:18},rpcUrls:{default:{http:[w],webSocket:[k]},public:{http:[w],webSocket:[k]},archive:{http:[`${w}/archive`],webSocket:["wss://porcini.devnet.rootnet.app/archive/ws"]}},contracts:{ensRegistry:{address:"0xA931c1F9621ECa562c258B81bF9fA8401f12241B"},ensUniversalResolver:{address:"0xB3c0AE882b35E72B7b84F7A1E0cF01fBDC617170",blockCreated:11983898}}}),p=_.defineChain({...g.rootPorcini,rpcUrls:{default:{http:["https://porcini.rootnet.app"],webSocket:["wss://porcini.rootnet.app/ws"]},archive:{http:["https://porcini.rootnet.app/archive"],webSocket:["wss://porcini.rootnet.app/archive/ws"]}},contracts:{...g.rootPorcini.contracts,ensBaseRegistrarImplementation:{address:"0x4420F023F0133F741e182f721b1DC2D3942fcb5A"},ensBulkRenewal:{address:"0xA7eA86ef8BeD3B3E36e8B08B108da297B8dC5A9a"},ensEthRegistrarController:{address:"0xd64FA152497175B18352F44D720e55bc67faB7EB"},ensNameWrapper:{address:"0xBDC394b7704d3E0DC963a6Cb0Db92cBA2054da23"},ensPublicResolver:{address:"0xaEb82E192d9DbA65478559034924e365bE366E5a"},ensRegistry:{address:"0xA931c1F9621ECa562c258B81bF9fA8401f12241B"},ensReverseRegistrar:{address:"0xDa3E37B6aA86749efF54b48983bcB908bB501c8a"},ensUniversalResolver:{address:"0xB3c0AE882b35E72B7b84F7A1E0cF01fBDC617170"},ensDnsRegistrar:{address:"0xB32cB5677a7C971689228EC835800432B339bA2B"},ensDnssecImpl:{address:"0x0fc3152971714E5ed7723FAFa650F86A4BaF30C5"}}}),L=_.defineChain({...g.root,rpcUrls:{default:{http:["https://root.rootnet.live"],webSocket:["wss://root.rootnet.live/ws"]},archive:{http:["https://root.rootnet.live/archive"],webSocket:["wss://root.rootnet.live/archive/ws"]}},contracts:{...g.root.contracts,ensBaseRegistrarImplementation:{address:"0xEeD3C3c547751e23020f4cb506FbA37baEb3308D"},ensBulkRenewal:{address:"0x0193eFBF9504422700295C022766891b0b10049F"},ensEthRegistrarController:{address:"0xc85E5802BADE56Facb93bb373da6bA7c1902b19c"},ensNameWrapper:{address:"0x44640D662A423d738D5ebF8B51E57AfC0f2cf4Df"},ensPublicResolver:{address:"0x870bC2604D6EAC536c791A603bFDE1A1448e168e"},ensRegistry:{address:"0xEC58C26B8E0A4bc0fe1ad21D216e4ecAd9e037A8"},ensReverseRegistrar:{address:"0xfFF7719aaB38eadE6A1CfdA864a174B715e9d673"},ensUniversalResolver:{address:"0x7808dF0A1F1d58c6Ad0F3bA07E749D730F02f13A"},ensDnsRegistrar:{address:"0xB32cB5677a7C971689228EC835800432B339bA2B"},ensDnssecImpl:{address:"0x0fc3152971714E5ed7723FAFa650F86A4BaF30C5"}}}),F=Object.freeze({production:{idpURL:"https://login.pass.online",signerURL:"https://signer.pass.online",chain:L},staging:{idpURL:"https://login.passonline.cloud",signerURL:"https://signer.passonline.cloud",chain:p},development:{idpURL:"https://login.passonline.dev",signerURL:"https://signer.passonline.dev",chain:p},neptune:{idpURL:"https://login.passonline.red",signerURL:"https://signer.passonline.red",chain:p},audit:{chain:p,idpURL:"https://login.futureverse.kiwi",signerURL:"https://signer.futureverse.kiwi"}}),c=Object.freeze({REDIRECT_FLOW:"redirect",SILENT_FLOW:"silent",POPUP_FLOW:"popup"}),u=Object.freeze({QUERY:"query",FRAGMENT:"fragment",FORM_POST:"form_post",WEB_MESSAGE:"web_message"}),m=r.z.union([r.z.literal("fv"),r.z.literal("self")]),M=r.z.object({eoa:r.z.string(),sub:r.z.string(),custodian:m,chainId:r.z.number(),futurepass:r.z.string(),nonce:r.z.string().optional(),s_hash:r.z.string().optional(),at_hash:r.z.string().optional(),aud:r.z.string(),exp:r.z.number(),iat:r.z.number(),iss:r.z.string()}),H=r.z.object({eoa:r.z.string(),chainId:r.z.number(),custodian:m,futurepass:r.z.string()}),S=(v=window.location.href)=>{const t=new URL(v,"http://127.0.0.1").search;return new URLSearchParams(t.slice(1))},T="authorization_response",U="logout_response";class f{constructor({silentRequestTimeoutInSeconds:e=10}){this._window=null,this._disposeHandlers=new Set,this.getResponseFromIframe=async t=>new Promise((n,i)=>{const o=setTimeout(()=>{i(new d.ErrorTimeout("IFrame timed out without a response"))},this._timeoutInSeconds*1e3);this._disposeHandlers.add(()=>clearTimeout(o));const a=l=>{var R;const h=l.data;if(![U,T].includes(h.type))return;if(h.type==U)return n({url:new URL("","http://127.0.0.1").href});const O=S(h.url),y=((R=h.response)==null?void 0:R.state)||O.get("state");(!y||y!==t.state)&&(this._dispose(),i(new Error("Invalid response from window")));const C=this.handleSignin(h);n({url:C})};window.addEventListener("message",a,!1),this._disposeHandlers.add(()=>window.removeEventListener("message",a,!1))}),this._timeoutInSeconds=e,this._frame=f.createHiddenIframe(),this._window=this._frame.contentWindow}static createHiddenIframe(){const e=window.document.createElement("iframe");return e.style.visibility="hidden",e.style.position="fixed",e.style.left="-1000px",e.style.top="0",e.width="0",e.height="0",window.document.body.appendChild(e),e}handleSignin(e){var s;const t=S(e.url);return e.response?`?${new URLSearchParams({...e.response,session_state:(s=e.response)!=null&&s.code?"active":""}).toString()}`:t.get("code")?(t.append("session_state","active"),`?${t.toString()}`):""}async navigate(e){if(!this._window)throw new Error("Attempted to navigate on a disposed window");this._window.location.replace(e.url);const t=await this.getResponseFromIframe(e);return this._dispose(),this.close(),t}_dispose(){for(const e of this._disposeHandlers)e();this._disposeHandlers.clear()}close(){var e;this._frame&&(this._frame.parentNode&&(this._frame.addEventListener("load",t=>{var n;const s=t.target;(n=s.parentNode)==null||n.removeChild(s)},!0),(e=this._frame.contentWindow)==null||e.location.replace("about:blank")),this._frame=null),this._window=null}static notifyParent(e,t=window.location.origin){window.parent.postMessage({type:T,url:e,keepOpen:!1},t)}}class D{constructor(e){this._settings=e}async callback(e){var t;f.notifyParent(e,(t=this._settings)==null?void 0:t.iframeNotifyParentOrigin)}async prepare(e){return new f(e)}}const B=30*1e3,N=60*60*1e3,I=24*60*60*1e3;class E{constructor(e){this._userStateHandler=[],this._notifiedSignedOut=!1,this._remoteSessionEventHandler=[],this._authLifecycleEventHandler=[],this.idTokenRenewTimer=null,this.getUserFromToken=i=>M.parse(A.jwtDecode(i));const{environment:t="production",signInFlow:s=c.REDIRECT_FLOW}=e;if(this.flow=s,this.environmentName=t,this.environment={...F[t]},this.config=e,e.authority&&(this.environment.idpURL=e.authority),e.signerAuthority&&(this.environment.signerURL=e.signerAuthority),!this.environment)throw new Error(`Invalid environment ${t}`);this.renewingIdToken=!1,this.userManagerSettings={post_logout_redirect_uri:e.postLogoutRedirectUri,client_id:e.clientId,redirect_uri:e.redirectUri,response_type:e.responseType,authority:`${this.environment.idpURL}`,scope:"openid",automaticSilentRenew:!0,userStore:new d.WebStorageStateStore({store:e.userStore??new b.CookieStorage({path:"/",sameSite:"Strict",expires:new Date(Date.now()+I)}),prefix:"fv."}),stateStore:new d.WebStorageStateStore({store:e.stateStore??new b.CookieStorage({path:"/",sameSite:"Strict",expires:new Date(Date.now()+I)}),prefix:"fv."})},e.clientSecret!=null&&(this.userManagerSettings={disablePKCE:!0,client_secret:e.clientSecret,...this.userManagerSettings});const n=new d.UserManagerSettingsStore(this.userManagerSettings);this.iframeNavigator=new D(n),this._userManager=new d.UserManager(this.userManagerSettings,e.redirectNavigator,e.popupNavigator,this.iframeNavigator),this._userManager.events.addUserLoaded(this._userLoaded.bind(this)),this._userManager.events.addUserUnloaded(this._userUnloaded.bind(this))}get OIDCManager(){return this._userManager}setState(e){this.state=e}setExtraQueryParams(e){this.extraQueryParams=e}async queryCustodialOptions(){return await fetch(`${this._userManager.settings.authority}/auth-options`,{headers:{"x-client-id":this._userManager.settings.client_id}}).then(e=>{if(e.ok===!1)throw new Error("Failed to load custodial options from authority");return e.json()}).catch(e=>(console.error(`Failed to fetch ${this._userManager.settings.authority}/auth-options`,e),[]))}async signInFuturepassSilent(e){try{this.updateAuthLifecycleEventHandlers("sign-in:start");const t={responseMode:u.WEB_MESSAGE,authFlow:c.SILENT_FLOW,...e},s=await this.generateFuturepassSignInArgs(t);return await this._userManager.signinSilent(s)}finally{this.updateAuthLifecycleEventHandlers("sign-in:end")}}async signInFuturepassRedirect(e){try{this.updateAuthLifecycleEventHandlers("sign-in:start");const t=await this.generateFuturepassSignInArgs(e);await this._userManager.signinRedirect(t)}finally{this.updateAuthLifecycleEventHandlers("sign-in:end")}}async signInFuturepassPopup(e){try{this.updateAuthLifecycleEventHandlers("sign-in:start");const t=await this.generateFuturepassSignInArgs(e);return await this._userManager.signinPopup({...t})}finally{this.updateAuthLifecycleEventHandlers("sign-in:end")}}async signInPass(e){const{address:t,authFlow:s=this.flow,extraQueryParams:n,responseMode:i=u.QUERY,signer:o,type:a}=e;return s===c.POPUP_FLOW?await this.signInFuturepassPopup({type:a,signer:o,address:t,state:this.state,extraQueryParams:n,responseMode:i}):s===c.SILENT_FLOW?await this.signInFuturepassSilent({state:this.state}):await this.signInFuturepassRedirect({type:a,signer:o,address:t,state:this.state,extraQueryParams:n,responseMode:i})}getSessionAuthType(){var e;if((e=this.userSession)!=null&&e.user)return E.getAuthType(this.userSession.user)}static getAuthType(e){const t=e.profile.sub.split(":");return t[0]==="eoa"&&t.length===2||t[0]==="xrpl"&&t[2]==="eoa"?"eoa":t[0]==="email"?"email":(t[0]==="idp",t[1])}static getCustodyType(e){const t=e.profile.sub.split(":");return t[0]==="email"||t[0]==="idp"?"Custodial":"SelfCustodial"}async generateEOALoginHint(e,t){function s(i){const a=i.replace(/^(?:\w+:)?\/\//,"").match(/^([^/:]+)/);return a?a[1]:null}const n=s(this.config.redirectUri)??"";return t.signPassOIDC({address:e.address,idpURL:this.environment.idpURL,chainId:this.environment.chain.id,domain:n})}async generateFuturepassSignInArgs(e){let t="",s;switch(e.type){case"eoa":{if(!e.signer)throw new Error("Must have signer for externally owned address");const i=await this.generateEOALoginHint(e,e.signer);t=i.hint,s=i.nonce}break;case"email":t="email:";break;case"facebook":t=`social:${e.type}`;break;case"google":t=`social:${e.type}`;break;case"tiktok":t=`social:${e.type}`;break;case"x":t="social:twitter";break;default:t=e.type||"";break}const n={...e.extraQueryParams,...this.extraQueryParams};return{prompt:e.authFlow==c.SILENT_FLOW?"none":"login",nonce:s,login_hint:t,scope:"openid",state:(e==null?void 0:e.state)||this.state,response_mode:e.responseMode||u.QUERY,...Object.keys(n).length>0&&{extraQueryParams:n}}}async signOut(e={flow:"redirect"}){var t;try{if(this.updateAuthLifecycleEventHandlers("sign-out:start"),await this._userManager.removeUser(),await((t=e.onBeforeRedirect)==null?void 0:t.call(e)),e.flow==="redirect"){window.location.href=`${this.environment.idpURL}/logout`;return}await this._userManager.signoutSilent()}finally{this.updateAuthLifecycleEventHandlers("sign-out:end")}}async signOutPass(e={flow:c.REDIRECT_FLOW,disableConsent:!0}){var t;this.updateAuthLifecycleEventHandlers("sign-out:start");try{if(await((t=e.onBeforeRedirect)==null?void 0:t.call(e)),e.flow===c.REDIRECT_FLOW){await this._userManager.signoutRedirect({...e.postRedirecturi?{post_logout_redirect_uri:e.postRedirecturi}:{},extraQueryParams:{...e.disableConsent?{disable_consent:!0}:{}}});return}await this._userManager.signoutSilent({extraQueryParams:{response_mode:u.WEB_MESSAGE}})}finally{this.updateAuthLifecycleEventHandlers("sign-out:end")}}async getUser(){return await this._userManager.getUser()}async loadUser(e){let t=await this._userManager.getUser();if(!t)try{const s=await this._userManager.signinCallback(e);s&&(t=s)}catch{}return this._userManager.startSilentRenew(),this._updateUserSession(t??void 0)}querySessionStatus(){return this._userManager.querySessionStatus({response_mode:u.WEB_MESSAGE})}async verifyAndLoadUser(){try{if(await this.handleCallback())return this.userSession;if(!await this.isLocalSessionActiveOnIDP())return await this.removeLocalUserSession(),await this.queryRemoteActiveSession(),this.userSession;const s=await this._userManager.getUser();return s?this._updateUserSession(s):this._updateUserSession()}catch(e){return e instanceof d.ErrorResponse&&await this._userManager.removeUser(),this._updateUserSession(),this.userSession}}async handleCallback(){const e=S(),{state:t,code:s,error:n}=new d.SigninResponse(e),i=await this._userManager.settings.stateStore.get(t||"");if(!(t&&i&&(s||n)))return!1;const a=await this._userManager.signinCallback();return a?(this._updateUserSession(a),!0):(n&&this._updateUserSession(),!1)}async removeLocalUserSession(){this._updateUserSession(),await this._userManager.removeUser()}async queryRemoteActiveSession(e){var i;const t=await this.iframeNavigator.prepare({silentRequestTimeoutInSeconds:e==null?void 0:e.silentRequestTimeoutInSeconds}),s=await this._userManager._client.createSigninRequest({request_type:"si:s",redirect_uri:this.userManagerSettings.silent_redirect_uri,prompt:"none",id_token_hint:void 0,scope:"openid",skipUserInfo:!0,response_mode:u.WEB_MESSAGE,...e});let n=null;try{const o=await t.navigate({url:s.url,state:s.state.id,response_mode:s.state.response_mode,scriptOrigin:this.userManagerSettings.iframeScriptOrigin}),a={},l=await this._userManager._client.processSigninResponse(o.url,a);return l.session_state==="active"&&!l.error&&(n=l.profile),n}catch{return await((i=this.userManagerSettings.stateStore)==null?void 0:i.remove(s.state.id)),n}finally{t.close(),this.updateRemoteSessionHandlers(n)}}async isLocalSessionActiveOnIDP(){const e=await this.getUser();return e?!e.expired&&await this.isTokenActive(e.access_token)?!0:e.refresh_token?!!await this.isTokenActive(e.refresh_token):!1:!1}async isTokenActive(e){const t=await fetch(`${this.environment.idpURL}/token/introspection`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({token:e,client_id:this.config.clientId})});if(!t.ok)throw new Error("Failed to introspect token");return(await t.json()).active}addUserStateListener(e){this._userStateHandler.push(e)}removeUserStateListener(e){const t=this._userStateHandler.indexOf(e);t>-1&&this._userStateHandler.splice(t,1)}addRemoteSessionListener(e){this._remoteSessionEventHandler.push(e)}removeRemoteSessionListener(e){const t=this._remoteSessionEventHandler.indexOf(e);t>-1&&this._remoteSessionEventHandler.splice(t,1)}updateRemoteSessionHandlers(e){this._remoteSessionEventHandler.forEach(t=>{t(e)})}addAuthLifecycleEventListener(e){this._authLifecycleEventHandler.push(e)}removeAuthLifecycleEventListener(e){const t=this._authLifecycleEventHandler.indexOf(e);t>-1&&this._authLifecycleEventHandler.splice(t,1)}updateAuthLifecycleEventHandlers(e){this._authLifecycleEventHandler.forEach(t=>{t(e)})}_sessionFromUser(e){if(!e)return;const t=e.profile,s=t.eoa,n=t.futurepass,i=t.chainId,o=t.custodian;return{eoa:s,chainId:i,custodian:o,futurepass:n,linked:[{eoa:s,chainId:i}],user:e}}_userLoaded(e){this._updateUserSession(e)}_userUnloaded(){this._userManager.stopSilentRenew(),this._updateUserSession()}_updateUserSession(e){var s,n;e?this.startIdTokenRenewTimer(e):this.stopIdTokenRenewTimer();const t=this._sessionFromUser(e);return this.userSession&&((s=this.userSession.user)==null?void 0:s.access_token)===((n=t==null?void 0:t.user)==null?void 0:n.access_token)?this.userSession:(this.userSession=t,this._updateHandlers(),this.userSession)}_updateHandlers(){if(!this.userSession){if(this._notifiedSignedOut)return;this._notifiedSignedOut=!0}this._userStateHandler.forEach(e=>{e(this.userSession)}),this.userSession&&(this._notifiedSignedOut=!1)}async renewIdToken(){if(this.renewingIdToken)return null;try{this.renewingIdToken=!0;const e=await this.signInFuturepassSilent(),t=e==null?void 0:e.id_token;if(t==null)throw new Error("cannot renew idToken");return t}catch{try{await this._userManager.signoutSilent()}catch{}finally{this._updateUserSession()}}finally{this.renewingIdToken=!1}return null}async renewIdTokenIfRequired(){var s,n;const e=(n=(s=this.userSession)==null?void 0:s.user)==null?void 0:n.id_token;return e==null?null:this.getRenewInMS(e,"manual")===0?await this.renewIdToken():e}getRenewInMS(e,t="auto"){const n=(A.jwtDecode(e).exp??0)*1e3,i=Date.now(),a=i>n?0:n-i-(t==="auto"?B:N);return Math.max(a,0)}startIdTokenRenewTimer(e){var o,a;const t=(a=(o=this.userSession)==null?void 0:o.user)==null?void 0:a.id_token,s=e.id_token;if(t!=null&&s!=null&&t==s&&this.idTokenRenewTimer!=null)return;const n=e.id_token;if(n==null)return;const i=this.getRenewInMS(n,"auto");this.idTokenRenewTimer!=null&&clearTimeout(this.idTokenRenewTimer),this.idTokenRenewTimer=setTimeout(async()=>{await this.renewIdToken()},i)}stopIdTokenRenewTimer(){this.idTokenRenewTimer&&clearTimeout(this.idTokenRenewTimer)}}Object.defineProperty(exports,"OIDCUser",{enumerable:!0,get:()=>d.User});exports.ENVIRONMENTS=F;exports.FLOW_TYPES=c;exports.FutureverseAuthClient=E;exports.RESPONSE_MODES=u;exports.custodianSchema=m;exports.identityTokenSchema=M;exports.porcini=p;exports.porciniDevNet=P;exports.root=L;exports.userSchema=H;
